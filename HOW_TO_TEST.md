# 如何測試新的泉威國安班表解析器

## 🎯 測試目標

驗證新的解析器能夠正確處理泉威國安班表格式，包含：
- 代碼式班別（A, B, O, C...）
- 橫向日期佈局
- 自動時數計算
- 跨日時間處理

---

## 📋 測試前準備

### 1. 檢查檔案是否已更新

確認以下檔案已經被修改：
- `gas-backend/test/ExcelParser.gs`
- `gas-backend/test/Code.gs`
- `gas-backend/test/TestUtils.gs`（新增）

### 2. 準備測試資料

確認有以下 Excel 檔案：
- `2026泉威國安班表.xlsx`（包含 11501 和 11502 工作表）

---

## 🧪 測試步驟

### 方法 1: GAS 編輯器內測試（推薦先執行）

#### Step 1: 開啟 GAS 編輯器

```bash
cd gas-backend/test
npx clasp open
```

#### Step 2: 執行測試函數

在 GAS 編輯器中：
1. 選擇函數：`testParseQuanWeiSchedule`
2. 點擊「執行」按鈕
3. 檢查「執行記錄」輸出

**預期看到的輸出：**
```
=== 開始測試泉威國安班表解析器 ===

--- 測試 1: 定位資料結構 ---
✅ 定位成功：日期列=3, 日期欄=9

--- 測試 2: 建立代碼字典 ---
✅ 代碼掃描成功：找到 5 個代碼

--- 測試 3: 完整解析 ---
  解析結果:
  - 總記錄數: X
  - 員工數: X
  - 班別代碼: A, A1, B, B1, O

--- 測試 4: 時間解析 ---
✅ 時間解析測試完成

--- 測試 5: 日期格式化 ---
✅ 全部測試項目通過

=== 測試完成 ===
總體結果: ✅ 全部通過
```

#### Step 3: 檢查環境設定

1. 選擇函數：`checkEnvironmentSetup`
2. 點擊「執行」
3. 確認所有項目都顯示 ✅

---

### 方法 2: 實際檔案上傳測試

#### Step 1: 推送程式碼到 GAS

```bash
cd gas-backend/test
npx clasp push
```

確認看到 `Pushed X files` 訊息。

#### Step 2: 開啟前端測試頁

用瀏覽器開啟：`frontend/index.html`（入口）→ 選擇測試環境，或直接開啟 `frontend/test/index.html`

#### Step 3: 測試 11501 工作表

1. 點擊「選擇檔案」，選擇 `2026泉威國安班表.xlsx`
2. 在「要解析的工作表名稱」欄位輸入：`11501`
3. 點擊「開始上傳並處理」
4. 等待處理完成

#### Step 4: 檢查結果

前往 Google Sheets（測試環境），檢查「國安班表」工作表：

**應該看到：**
```
員工姓名 | 排班日期   | 上班時間 | 下班時間 | 工作時數
TiNg     | 2026/01/23 | 10:00    | 20:30    | 10.5
TiNg     | 2026/01/29 | 10:00    | 20:30    | 10.5
茶葉       | 2026/01/21 | 10:00    | 20:30    | 10.5
...（共約 21 筆記錄）
```

**檢查項目：**
- [ ] 標題列是藍底白字
- [ ] 日期格式為 YYYY/MM/DD
- [ ] 時間格式為 HH:MM
- [ ] 工作時數為數字（一位小數）
- [ ] 沒有空白列或錯誤資料

#### Step 5: 檢查 Log

開啟「Log」工作表，檢查最新的記錄：

**應該看到：**
- `OPERATION` - 開始解析泉威國安班表: 11501
- `DEBUG` - 找到的班別代碼
- `DEBUG` - 資料結構配置
- `DEBUG` - 處理員工: XXX
- `OPERATION` - 泉威國安班表解析完成

#### Step 6: 測試 11502 工作表

重複 Step 3-5，但輸入工作表名稱為 `11502`

**預期結果：**
- 約 55 筆記錄
- 4 位員工（TiNg、茶葉、魚、玗璿）
- 6 種班別代碼（A, A1, B, B1, C, O）

**特別注意 C 代碼：**
```
TiNg | 2026/02/02 | 12:30 | 16:30 | 4.0  (C 中班)
```

---

## ✅ 驗收標準

### 必須通過的檢查項

#### GAS 測試
- [ ] `testParseQuanWeiSchedule()` 執行成功
- [ ] `checkEnvironmentSetup()` 顯示環境正常
- [ ] 無錯誤訊息出現

#### 11501 測試
- [ ] 21 筆記錄
- [ ] 3 位員工
- [ ] 5 種代碼（A, A1, B, B1, O）
- [ ] 資料格式正確

#### 11502 測試
- [ ] 55 筆記錄
- [ ] 4 位員工
- [ ] 6 種代碼（A, A1, B, B1, C, O）
- [ ] C 代碼（中班）正確解析

#### 資料品質
- [ ] 沒有空白記錄
- [ ] 日期連續無遺漏
- [ ] 時數計算正確
- [ ] 跨日時間正確（如有）

#### Log 記錄
- [ ] 完整記錄解析過程
- [ ] 包含代碼掃描結果
- [ ] 包含員工統計
- [ ] 無錯誤 Log

---

## 🐛 常見問題排除

### 問題 1: 找不到代碼定義

**症狀：** Log 顯示「找到 0 個代碼」

**檢查：**
1. Excel 中代碼定義列是否以 `*` 開頭
2. 格式是否為 `* A 10:00-17:00`
3. 代碼和時間範圍之間有空格

**解決：** 確保 Excel 格式正確

### 問題 2: 找不到日期列

**症狀：** 錯誤訊息「找不到日期列（1, 2, 3...）」

**檢查：**
1. 日期列是否包含數字 1
2. 日期列是否在前 10 列
3. 數字 1 是否在第 2-15 欄之間

**解決：** 調整 Excel 格式或修改 `locateDataStructure()` 搜尋範圍

### 問題 3: 沒有解析到員工資料

**症狀：** 總記錄數為 0

**檢查：**
1. 員工姓名是否在日期列下方第 2 列
2. 員工姓名欄位是否為空
3. 是否遇到終止關鍵字

**解決：** 確認 Excel 格式，調整 `startRow` 偏移量

### 問題 4: Google Sheets 連線失敗

**症狀：** 錯誤訊息「無法開啟 Google Sheets」

**檢查：**
1. Script Properties 中的 `SHEET_ID` 是否正確
2. Google Sheets 是否存在
3. GAS 是否有權限存取

**解決：** 執行 `checkEnvironmentSetup()` 檢查設定

---

## 📊 測試結果記錄表

| 測試項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| GAS 測試 | 全部通過 | | ⬜ | |
| 11501 解析 | 21 筆記錄 | | ⬜ | |
| 11502 解析 | 55 筆記錄 | | ⬜ | |
| 代碼掃描 | A,A1,B,B1,O/C | | ⬜ | |
| 資料格式 | 正確 | | ⬜ | |
| Log 記錄 | 完整 | | ⬜ | |

---

## 🚀 測試通過後的下一步

1. **更新 CONTEXT.md**
   - 記錄替換完成
   - 更新已實作功能清單

2. **部署到正式環境**
   ```bash
   cd gas-backend/prod
   npx clasp push
   ```

3. **更新部署記錄**
   - 在 CONTEXT.md 中新增部署記錄
   - 記錄版本號和變更內容

4. **提交到 Git**
   ```bash
   git add .
   git commit -m "替換為泉威國安班表專用解析器"
   git push
   ```

---

**測試指南更新日期：** 2026-02-06  
**版本：** v1.0
