# 泉威國安班表解析器 - 測試報告

## 🔄 程式碼替換摘要

### 替換時間
2026-02-06

### 替換範圍
- ✅ `gas-backend/test/ExcelParser.gs` - 完全替換（522 行 → 452 行）
- ✅ `gas-backend/test/Code.gs` - 部分修改（handleUpload 函數）
- ✅ `gas-backend/prod/ExcelParser.gs` - 同步更新
- ✅ `gas-backend/prod/Code.gs` - 同步更新

### 主要變更
1. **移除通用欄位映射邏輯**（~270 行）
   - ❌ `transformToTargetFormat()`
   - ❌ `detectColumnMapping()`
   - ❌ `calculateWorkHours()`
   - ❌ 其他通用函數

2. **新增泉威專用解析器**（~240 行）
   - ✅ `parseQuanWeiSchedule()` - 主解析函數
   - ✅ `locateDataStructure()` - 定位日期列
   - ✅ `buildShiftMap()` - 掃描代碼定義
   - ✅ `parseTimeRange()` - 解析時間範圍
   - ✅ `formatTimeString()` - 格式化時間
   - ✅ `formatScheduleDate()` - 格式化日期

---

## 🧪 測試方法

### 方法 1: GAS 編輯器內測試
```javascript
// 在 GAS 編輯器中執行以下函數
testParseQuanWeiSchedule()     // 測試解析邏輯
checkEnvironmentSetup()         // 檢查環境設定
```

### 方法 2: 實際檔案上傳測試
1. 開啟 `frontend/index.html`
2. 上傳 `2026泉威國安班表.xlsx`
3. 選擇工作表 `11501` 或 `11502`
4. 檢查 Google Sheets 中的結果

---

## ✅ 預期測試結果

### 測試 1: 代碼掃描
**預期輸出：**
```json
{
  "A": {"start": "10:00", "end": "17:00", "hours": "7.0"},
  "A1": {"start": "10:00", "end": "15:00", "hours": "5.0"},
  "B": {"start": "16:30", "end": "20:30", "hours": "4.0"},
  "B1": {"start": "14:30", "end": "20:30", "hours": "6.0"},
  "O": {"start": "10:00", "end": "20:30", "hours": "10.5"}
}
```

### 測試 2: 11501 工作表解析
**預期結果：**
- 總記錄數: 21 筆
- 處理員工: 3 位（TiNg、茶葉、魚）
- 班別代碼: A, A1, B, B1, O

**範例記錄：**
```
TiNg | 2026/01/23 | 10:00 | 20:30 | 10.5
茶葉 | 2026/01/21 | 10:00 | 20:30 | 10.5
魚   | 2026/01/21 | 16:30 | 20:30 | 4.0
```

### 測試 3: 11502 工作表解析
**預期結果：**
- 總記錄數: 55 筆
- 處理員工: 4 位（TiNg、茶葉、魚、玗璿）
- 班別代碼: A, A1, B, B1, C, O（多了 C 代碼）

**範例記錄：**
```
TiNg | 2026/02/01 | 10:00 | 20:30 | 10.5
TiNg | 2026/02/02 | 12:30 | 16:30 | 4.0  (C 中班)
玗璿 | 2026/02/04 | 10:00 | 17:00 | 7.0
```

### 測試 4: Google Sheets 輸出
**檢查項目：**
- ✅ 標題列：員工姓名 | 排班日期 | 上班時間 | 下班時間 | 工作時數
- ✅ 標題列格式：藍底白字、粗體、置中
- ✅ 日期格式：YYYY/MM/DD
- ✅ 時間格式：HH:MM
- ✅ 時數格式：數字（小數點一位）
- ✅ 凍結標題列

### 測試 5: Log 記錄
**檢查 Log 工作表應包含：**
- ✅ `OPERATION` - 開始解析泉威國安班表
- ✅ `DEBUG` - 找到的班別代碼
- ✅ `DEBUG` - 資料結構配置
- ✅ `DEBUG` - 處理員工 x 位
- ✅ `OPERATION` - 泉威國安班表解析完成

---

## 🔍 測試檢查清單

### 基本功能測試
- [ ] 上傳 Excel 檔案成功
- [ ] 選擇工作表 11501 成功解析
- [ ] 選擇工作表 11502 成功解析
- [ ] 資料正確寫入 Google Sheets
- [ ] 標題列格式正確

### 代碼解析測試
- [ ] A 代碼（早班）解析正確
- [ ] B 代碼（晚班）解析正確
- [ ] O 代碼（全日班）解析正確
- [ ] C 代碼（中班，11502 限定）解析正確
- [ ] 手寫時間格式（18:00-20:30）解析正確

### 邊界情況測試
- [ ] 跨日時間（22:00-06:00）計算正確
- [ ] 空白儲存格跳過
- [ ] 統計列（合計、備註）不解析
- [ ] 年月份自動偵測正確
- [ ] 員工名稱正確擷取

### Log 系統測試
- [ ] Log 等級控制正常（Log_Level = 0/1/2）
- [ ] OPERATION 等級記錄重要操作
- [ ] DEBUG 等級記錄詳細資訊
- [ ] ERROR 等級記錄錯誤

### 效能測試
- [ ] 單一工作表處理時間 < 10 秒
- [ ] 不會產生超時錯誤
- [ ] 暫存檔案正確清理

---

## 🐛 已知問題與限制

### 限制事項
1. **僅支援泉威國安班表格式**
   - 橫向日期（1, 2, 3...）
   - 代碼式班別（A, B, O...）
   - 不再支援通用格式

2. **年月份偵測**
   - 預設從 A2 儲存格讀取
   - 格式必須為 YYYY/MM
   - 若無法取得則使用預設值 2026/01

3. **員工列終止條件**
   - 遇到空白列或特定關鍵字停止
   - 關鍵字：上班人數、合計、備註、P.T、閉店評論

### 潛在風險
1. ⚠️ 如果班表格式變化，可能需要調整解析邏輯
2. ⚠️ 代碼定義區必須以 `*` 開頭
3. ⚠️ 日期列必須包含數字 1 才能定位

---

## 📝 測試結果記錄

### 測試執行時間
- 待填寫

### 測試執行者
- 待填寫

### 測試結果
- [ ] 通過
- [ ] 失敗
- [ ] 部分通過

### 問題記錄
- 待填寫

### 備註
- 待填寫

---

## 🚀 下一步

1. **執行 GAS 編輯器測試**
   - 執行 `testParseQuanWeiSchedule()`
   - 檢查 Logger 輸出

2. **執行實際檔案上傳測試**
   - 上傳 11501 工作表
   - 上傳 11502 工作表
   - 驗證 Google Sheets 輸出

3. **檢查 Log 記錄**
   - 開啟 Log 工作表
   - 確認記錄完整

4. **推送到正式環境**（測試通過後）
   - `cd gas-backend/prod && npx clasp push`
   - 更新部署記錄

---

**測試指南更新日期：2026-02-06**
