# 調整功能說明

本文件說明薪資計算系統的調整功能設計與使用方式。

---

## 1. 功能概述

調整功能允許使用者在系統計算薪資後，檢視計算結果並進行人工修正。所有調整動作都會記錄在「調整歷程記錄」表中，確保可追溯性。

---

## 2. 調整流程

```
系統計算完成
    ↓
使用者檢視結果
    ↓
發現需要調整的項目
    ↓
點擊「調整」按鈕
    ↓
填寫調整內容與理由（必填）
    ↓
儲存調整
    ↓
系統記錄調整歷程
    ↓
使用者確認（二次確認）
    ↓
系統寫入最終結果
```

---

## 3. 可調整項目

目前版本**不限制**可調整的欄位，所有薪資相關欄位皆可調整。

### 常見調整項目

| 項目 | 說明 | 範例 |
|------|------|------|
| 工作天數 | 修正實際工作天數 | 原 22 天 → 21 天 |
| 總工時 | 修正總工作時數 | 原 176 小時 → 170 小時 |
| 正常工時 | 修正正常工時 | 原 176 小時 → 168 小時 |
| 加班工時 | 修正加班時數 | 原 10 小時 → 8 小時 |
| 基本薪資 | 修正基本薪資 | 原 35,200 元 → 33,600 元 |
| 加班費 | 修正加班費 | 原 2,680 元 → 2,144 元 |
| 總薪資 | 直接修正總薪資 | 原 37,880 元 → 40,000 元 |
| 津貼 | 新增或修正津貼 | 新增全勤獎金 2,000 元 |
| 扣款 | 新增或修正扣款 | 新增請假扣款 800 元 |

### 未來可擴充

- 限制特定欄位不可調整（例如：員工編號、員工姓名）
- 依使用者角色限制可調整的欄位
- 設定調整上下限（例如：總薪資不可超過原值的 120%）

---

## 4. 調整理由

### 必填項目
每次調整**必須**填寫理由，理由將記錄在「調整歷程記錄」表中。

### 理由範例
- ✅ 「實際加班時數應為 8 小時，原計算誤判為 10 小時」
- ✅ 「補發全勤獎金 2,000 元」
- ✅ 「員工請事假 1 天，扣款 1,600 元」
- ✅ 「缺卡資料已人工核對，實際工時為 8 小時」
- ❌ 「調整」（太簡略）
- ❌ 「修改」（未說明原因）

---

## 5. 調整歷程記錄

### 記錄內容

所有調整動作會記錄以下資訊：

| 欄位 | 說明 | 範例 |
|------|------|------|
| 時間戳記 | 調整時間 | 2024-01-05 14:30:00 |
| Job ID | 批次編號 | job_20240101_123456 |
| 員工編號 | 被調整的員工 | E002 |
| 員工姓名 | 員工姓名 | 李四 |
| 調整欄位 | 被調整的欄位名稱 | overtimeHours |
| 原始值 | 調整前的值 | 10 |
| 調整後值 | 調整後的值 | 8 |
| 調整理由 | 使用者填寫的理由 | 實際加班時數應為 8 小時 |
| 操作者 | 執行調整的人（未來擴充） | admin@example.com |

### 記錄保存

- 調整歷程記錄**永久保存**在 Google Sheets
- 不可刪除或修改已記錄的調整歷程
- 可依 Job ID、員工編號、時間等條件查詢

---

## 6. 二次確認機制

### 目的
避免使用者誤操作，確保調整結果正確無誤。

### 流程

1. **使用者點擊「確認」**：完成所有調整後點擊確認按鈕
2. **顯示調整摘要**：系統顯示對話框，列出本次所有調整項目
3. **使用者檢視**：使用者檢視調整摘要
4. **再次確認**：使用者點擊「確定」或「取消」
   - 確定：系統寫入最終結果，完成流程
   - 取消：返回調整頁面，可繼續修改

### 調整摘要範例

```
調整摘要

本次共調整 2 位員工的薪資資料：

1. E002 李四
   - 加班工時：10 小時 → 8 小時
   - 理由：實際加班時數應為 8 小時

2. E003 王五
   - 總薪資：30,000 元 → 32,000 元
   - 理由：補發全勤獎金 2,000 元

請確認以上調整內容是否正確？

[確定] [取消]
```

---

## 7. 確認後修改

### 功能說明
使用者確認並儲存最終結果後，仍可返回修改。

### 修改流程

1. 使用者在完成頁面點擊「返回修改」
2. 系統導向檢視與調整頁面
3. 使用者進行修改
4. 重新執行確認流程
5. 系統寫入新的最終結果（覆蓋舊的）
6. 調整歷程記錄保留所有調整動作（包含修改前後）

### 版本管理

- 「計算結果（原始）」：永遠保持不變，為系統初始計算結果
- 「計算結果（調整後）」：每次調整後更新
- 「最終確認結果」：每次確認後更新（可能被覆蓋）
- 「調整歷程記錄」：累積所有調整動作，不會被覆蓋

---

## 8. 前端 UI 設計

### 8.1 檢視頁面

#### 摘要區
- 顯示總人數、總薪資
- 顯示異常筆數（缺卡、遲到、早退等）

#### 員工列表
- 表格顯示所有員工的薪資摘要
- 支援搜尋、篩選、排序
- 異常項目以紅色標記

#### 詳細區（展開式）
- 點擊員工列可展開詳細資訊
- 顯示考勤明細（每日出勤狀況）
- 顯示計算明細（正常工時、加班工時、薪資組成）
- 可編輯欄位以輸入框或下拉選單呈現

### 8.2 調整操作

#### 編輯模式
- 點擊「編輯」按鈕進入編輯模式
- 可編輯的欄位變為可輸入狀態
- 即時顯示調整前後的對比

#### 調整理由
- 每個員工的調整區塊下方顯示「調整理由」輸入框
- 必填，未填寫無法儲存

#### 儲存與取消
- 「儲存」：儲存該員工的調整
- 「取消」：放棄調整，恢復原值

### 8.3 確認頁面

#### 調整摘要
- 列出所有調整項目
- 使用表格或卡片式設計呈現

#### 操作按鈕
- 「確定」：確認無誤，寫入最終結果
- 「取消」：返回調整頁面

---

## 9. API 設計

### 9.1 取得計算結果

```
GET /result?jobId=job_20240101_123456
```

回應範例見 [API.md](API.md)。

### 9.2 提交調整

```
POST /adjust
{
  "jobId": "job_20240101_123456",
  "adjustments": [
    {
      "employeeId": "E002",
      "field": "overtimeHours",
      "oldValue": 10,
      "newValue": 8,
      "reason": "實際加班時數應為 8 小時"
    }
  ]
}
```

### 9.3 確認最終結果

```
POST /confirm
{
  "jobId": "job_20240101_123456"
}
```

詳細 API 規格見 [API.md](API.md)。

---

## 10. 安全性考量

### 10.1 權限控制（未來擴充）

- 一般使用者：可調整自己上傳的資料
- 主管：可調整所有資料
- 唯讀使用者：僅可檢視，不可調整

### 10.2 資料驗證

- 前端驗證：確保輸入格式正確（數字、日期等）
- 後端驗證：再次檢查資料合理性
- 避免惡意輸入（SQL Injection、XSS 等）

### 10.3 操作記錄

- 記錄所有調整動作（時間、使用者、內容）
- 供日後稽核使用

---

## 11. 測試案例

### 11.1 單元測試

- 測試調整功能的各個函數
- 測試資料驗證邏輯
- 測試調整歷程記錄寫入

### 11.2 整合測試

- 測試完整的調整流程
- 測試二次確認機制
- 測試確認後修改功能

### 11.3 使用者測試

- 確認 UI 易用性
- 確認錯誤訊息清楚
- 確認流程順暢

---

## 12. 未來擴充

### 12.1 批次調整

- 支援一次調整多位員工
- 支援套用相同的調整規則

### 12.2 調整範本

- 常用調整項目可儲存為範本
- 下次可直接套用

### 12.3 審核流程

- 調整後需經主管審核
- 審核通過才寫入最終結果

### 12.4 調整權限細分

- 依角色限制可調整的欄位
- 設定調整上下限

---

**更新日期**: 2024-01-01
