# 欄位映射說明

## 概述

本文件說明系統如何將上傳的 Excel 資料轉換為目標 Google Sheets「國安班表」的格式。

## 目標格式

Google Sheets「國安班表」的欄位結構：

| 欄位名稱 | 資料型別 | 說明 | 範例 |
|---------|---------|------|------|
| 員工姓名 | 文字 | 員工的姓名 | 張三 |
| 排班日期 | 日期 | 工作日期，格式 YYYY-MM-DD | 2026-01-15 |
| 上班時間 | 時間 | 上班時間，格式 HH:MM | 08:00 |
| 下班時間 | 時間 | 下班時間，格式 HH:MM | 17:00 |
| 工作時數 | 數字 | 自動計算的工作時數 | 9.00 |
| 備註 | 文字 | 額外說明（選填） | 加班 |

## 自動欄位偵測

系統會自動偵測上傳 Excel 的欄位名稱，支援多種變體：

### 員工姓名
- **可識別的欄位名稱**：員工姓名、姓名、員工、人員、name、employee
- **映射到**：員工姓名

### 排班日期
- **可識別的欄位名稱**：排班日期、日期、工作日期、date、schedule
- **映射到**：排班日期
- **格式轉換**：自動轉換為 YYYY-MM-DD 格式

### 上班時間
- **可識別的欄位名稱**：上班時間、開始時間、起始時間、start、begin
- **映射到**：上班時間
- **格式轉換**：自動轉換為 HH:MM 格式

### 下班時間
- **可識別的欄位名稱**：下班時間、結束時間、完成時間、end、finish
- **映射到**：下班時間
- **格式轉換**：自動轉換為 HH:MM 格式

### 備註
- **可識別的欄位名稱**：備註、說明、註記、note、remark、comment
- **映射到**：備註
- **特性**：選填欄位，如果 Excel 中沒有此欄位，會自動填入空值

## 工作時數計算

「工作時數」欄位會由系統自動計算：

### 計算公式
```
工作時數 = 下班時間 - 上班時間
```

### 特殊情況
- **跨日班次**：如果下班時間小於上班時間，系統會自動加上 24 小時（例如：22:00 上班，06:00 下班 = 8 小時）
- **無效時間**：如果無法解析時間，工作時數會設為 0
- **精確度**：四捨五入到小數點後 2 位

### 範例
| 上班時間 | 下班時間 | 工作時數 |
|---------|---------|---------|
| 08:00 | 17:00 | 9.00 |
| 09:30 | 18:45 | 9.25 |
| 22:00 | 06:00 | 8.00 (跨日) |

## 資料寫入模式

### 附加模式（預設）
- 系統會將轉換後的資料**附加**到現有資料的最後
- 第一次上傳時會包含標題列
- 後續上傳會跳過標題列，只附加資料列
- 現有資料**不會被刪除**

### 範例
```
現有資料：
員工姓名 | 排班日期 | 上班時間 | 下班時間 | 工作時數 | 備註
張三     | 2026-01-15 | 08:00 | 17:00 | 9.00 | 

上傳資料後：
員工姓名 | 排班日期 | 上班時間 | 下班時間 | 工作時數 | 備註
張三     | 2026-01-15 | 08:00 | 17:00 | 9.00 | 
李四     | 2026-01-16 | 09:00 | 18:00 | 9.00 | 加班
```

## 日期與時間格式處理

### 日期格式
系統支援以下輸入格式，並自動轉換為 `YYYY-MM-DD`：
- `2026-01-15`（標準格式）
- `2026/01/15`
- Excel 日期序號（自動轉換）

### 時間格式
系統支援以下輸入格式，並自動轉換為 `HH:MM`：
- `08:00`（標準格式）
- `8:00`（單位數小時）
- `08:00:00`（含秒）
- Excel 時間序號（自動轉換）

## 錯誤處理

### 欄位偵測失敗
如果必要欄位（員工姓名、排班日期、上班時間、下班時間）無法自動偵測：
- 系統會在 Log 中記錄警告訊息
- 詳細列出無法偵測的欄位和實際的欄位名稱
- 建議檢查 Excel 的標題列是否正確

### 資料格式錯誤
如果資料格式無法解析：
- 日期：保留原始值，不進行轉換
- 時間：保留原始值，工作時數設為 0
- 系統會在 Log 中記錄警告訊息

### 空白列處理
系統會自動跳過完全空白的列，不會寫入 Google Sheets。

## 日誌記錄

所有欄位映射和轉換過程都會記錄在 Google Sheets 的「Log」工作表中：

### 記錄內容
- **原始欄位標題**：上傳 Excel 的所有欄位名稱
- **欄位映射結果**：偵測到的欄位對應關係
- **範例資料**：前 3 列的範例資料（用於檢查）
- **轉換統計**：來源列數、目標列數、跳過的空白列數

### 查看方式
在 Google Sheets 中開啟「Log」工作表，篩選 `Level = OPERATION` 查看欄位映射記錄。

## 常見問題

### Q: 如果 Excel 欄位名稱與預設不同怎麼辦？
A: 系統支援多種變體和英文欄位名稱，請參考「自動欄位偵測」章節。如果仍無法識別，請修改 Excel 的標題列，使用支援的欄位名稱。

### Q: 工作時數是否可以手動修改？
A: 系統會自動計算工作時數。如需修改，可在資料上傳後直接在 Google Sheets 中編輯。

### Q: 資料會覆蓋現有資料嗎？
A: 不會。系統使用「附加模式」，所有資料會附加到現有資料的最後。

### Q: 如何清空現有資料重新上傳？
A: 目前需要手動在 Google Sheets 中刪除「國安班表」工作表的資料。未來版本會提供「清空重新上傳」選項。

## 開發資訊

### 相關檔案
- `gas-backend/test/ExcelParser.gs`：欄位映射和資料轉換邏輯
- `gas-backend/test/SheetService.gs`：資料寫入邏輯

### 測試函數
在 GAS 編輯器中執行 `exportSheetStructure()` 可以查看目標 Google Sheets 的結構。
