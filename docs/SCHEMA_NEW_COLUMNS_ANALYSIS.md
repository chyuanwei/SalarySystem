# 打卡／班表新欄位分析

## 1. 你新增的欄位對照

### 打卡 sheet

| 欄位 | 欄位代號 | 0-based index | 說明 |
|------|----------|---------------|------|
| 分店 | A | 0 | （既有） |
| 員工編號 | B | 1 | （既有） |
| 員工帳號 | C | 2 | （既有） |
| 員工姓名 | D | 3 | （既有） |
| 打卡日期 | E | 4 | （既有） |
| 上班時間 | F | 5 | （既有） |
| 下班時間 | G | 6 | （既有） |
| 工作時數 | H | 7 | （既有） |
| 狀態 | I | 8 | （既有） |
| 備註 | J | 9 | （既有） |
| **是否有效** | **K** | **10** | 新建：該筆打卡是否為「有效」（未被校正取代） |
| **校正備註** | **L** | **11** | 新建：校正時填寫的備註 |
| **建立時間** | **M** | **12** | 新建：上傳建立此筆打卡的時間 |
| **校正時間** | **N** | **13** | 新建：此筆被校正的時間（若為校正後的新筆才會有值） |

### 班表 sheet

| 欄位 | 欄位代號 | 0-based index | 說明 |
|------|----------|---------------|------|
| 員工姓名 | A | 0 | （既有） |
| 排班日期 | B | 1 | （既有） |
| 上班 | C | 2 | （既有） |
| 下班 | D | 3 | （既有） |
| 時數 | E | 4 | （既有） |
| 班別 | F | 5 | （既有） |
| 分店 | G | 6 | （既有） |
| 備註 | H | 7 | （既有） |
| **建立時間** | **I** | **8** | 新建：班表上傳時的建立時間 |
| **修改時間** | **J** | **9** | 新建：班表資料被修改（例如備註）的時間 |

---

## 2. 程式碼現狀與需調整處

### 2.1 打卡 sheet

- **目前程式假設**：只有 A–J 共 10 欄（到 index 9）。  
  - `Code.gs` 打卡上傳：`headerRow = ['分店','員工編號','員工帳號','員工姓名','打卡日期','上班時間','下班時間','工作時數','狀態','備註']`，寫入時只有 10 欄。  
  - `SheetService.buildAttendanceDedupKey`、`removeAttendanceRowsByYearMonthAndBranch`、`appendAttendanceToSheet` 讀取時用到的欄位都在 0–8 內。  
  - `updateAttendanceRemark` 寫備註到第 10 欄（index 9，J）。

- **你已在試算表手動加 K、L、M、N**，因此：
  - **寫入**：上傳打卡時應一併寫入 **是否有效**、**建立時間**；新筆寫「是」與上傳當下時間，舊筆（若未來有「先標無效再補新筆」）再寫「否」。
  - **讀取**：比對／算薪時應只讀 **是否有效 = 是** 的列（或排除「否」），並可依需要讀 **校正備註、建立時間、校正時間**。
  - **校正流程**（若改為寫回打卡）：找到原筆 → 將該列 **是否有效** 改為「否」→ 新增一列，複製並改 上班/下班/時數，**是否有效**=「是」、**校正備註**=使用者輸入、**校正時間**=現在、**建立時間**=可留空或沿用原筆。

建議在程式裡把「打卡欄位」抽成常數（例如 `ATTENDANCE_COLUMNS` 或註解表），並將 **K=10, L=11, M=12, N=13** 寫死或依表頭 index 查詢，避免之後再對錯欄。

### 2.2 班表 sheet

- **目前程式假設**：A–H 共 8 欄（到 index 7）。  
  - `SheetService.removeScheduleRowsByYearMonthAndBranch` 用 `getRange(2, 1, lastRow, 7)`。  
  - `updateScheduleRemark` 寫備註到第 8 欄（index 7，H）。

- **你已手動加「建立時間」「修改時間」**後：
  - **寫入**：班表上傳時應多寫兩欄：**建立時間**=上傳當下時間；**修改時間**=可先留空。
  - **修改**：當「更新班表備註」或任何會改班表資料的流程執行時，應同時更新該列的 **修改時間**=現在。

同樣建議在程式裡固定「班表欄位」與 index（例如 建立時間=8、修改時間=9），避免日後對錯欄。

---

## 3. 建議修改清單（依功能）

### 3.1 打卡上傳（Code.gs + SheetService）

- 擴充 `headerRow` 與每筆 `dataRows` 為 **14 欄**（A–N）。
- 每筆新寫入的列：
  - **是否有效**（K, index 10）= `'是'`
  - **校正備註**（L, index 11）= `''`
  - **建立時間**（M, index 12）= 上傳當下時間（例如 `Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss')`）
  - **校正時間**（N, index 13）= `''`
- `appendAttendanceToSheet`、`buildAttendanceDedupKey`、`removeAttendanceRowsByYearMonthAndBranch` 若有用到「最後一欄」或「總欄數」，需改為 14 欄或至少讀到 N（例如 getRange 時 lastCol 改為 14）。

### 3.2 班表上傳（Code.gs / Excel 寫入班表處）

- 班表寫入時每列改為 **10 欄**（A–J）。
- 新增兩欄：
  - **建立時間**（I, index 8）= 上傳當下時間
  - **修改時間**（J, index 9）= `''`
- 若目前寫入班表是透過 SheetService 的某個「寫入多列」函式，需一併傳入這兩欄或在那裡補上。

### 3.3 更新班表備註（SheetService.updateScheduleRemark）

- 找到對應列後，除了寫 **備註**（H, index 7）外，再寫 **修改時間**（J, index 9）= 現在時間。
- 若班表目前 getRange 只取 8 欄，需改為至少 10 欄再 setValue，或單獨 `getRange(i+2, 10).setValue(now)`。

### 3.4 更新打卡備註（SheetService.updateAttendanceRemark）

- 目前寫 **備註** 到 J（index 9）。你新增的是 **校正備註** 在 L（index 11）。  
  - 若「更新打卡備註」指的是既有的「備註」欄，則仍寫 J，不需改欄位。  
  - 若希望「備註」與「校正備註」分開，則程式邏輯上要區分：一般備註寫 J，校正備註寫 L。目前前端若有「打卡備註」與「校正備註」，可對應到 J 與 L。
- 若未來校正改為寫回打卡（見下），則「校正備註」會在寫入新列時填到 L，不需在 updateAttendanceRemark 裡寫 L，除非有單獨「只改校正備註」的 API。

### 3.5 讀取打卡（CompareService.readAttendanceByConditions、SheetService 等）

- 若比對／算薪只關心「有效」的打卡：
  - 在 `readAttendanceByConditions` 或讀取打卡的迴圈裡，多加條件：`row[10] === '是'`（或排除 `row[10] === '否'`），只把有效列放進 `filtered`。
- 若 sheet 已有 K–N，讀取時 getRange 的欄數要至少到 14，否則 row[10] 以後會是 undefined。

### 3.6 校正寫回打卡（尚未實作，你之前討論的方向）

- 在 **打卡** sheet：
  - 找到要取代的那一列（分店、員工帳號、日期、上班、下班 皆符合）。
  - 將該列 **是否有效**（K）設為 `'否'`。
  - **Append 一列**：同該筆的 分店～狀態、備註，但 上班/下班/時數 改為校正值；**是否有效**=`'是'`，**校正備註**=使用者輸入，**建立時間**=可留空或原筆的建立時間，**校正時間**=現在。
- 這樣「有效」的只有一筆，算薪只讀有效列即可。

---

## 4. 小結

| 項目 | 目前程式 | 你新增的欄位 | 建議 |
|------|----------|--------------|------|
| 打卡 | 10 欄 (A–J) | K 是否有效, L 校正備註, M 建立時間, N 校正時間 | 上傳時寫滿 14 欄並填 K/M；讀取時篩選「是否有效=是」；校正寫回時改舊列 K=否、新列 K=是＋L/N |
| 班表 | 8 欄 (A–H) | I 建立時間, J 修改時間 | 上傳時寫 10 欄並填 I；更新備註時一併寫 J=現在 |

實作時建議：
1. 在 Config 或 SheetService 開頭定義「打卡／班表欄位名稱與 index」常數，之後讀寫都依此索引，避免魔術數字。
2. 先做「上傳時寫入新欄位」與「讀取時篩選是否有效」，再做「校正寫回打卡」與「班表修改時間」。

若你願意，我可以依這份分析下一步直接改某一塊（例如先改打卡上傳 14 欄＋建立時間＋是否有效）。
